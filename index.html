<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roleta da Sorte</title>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
}

body{
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(135deg,#8b0000,#b22222);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
}

.container{
    width:520px;
    background:white;
    padding:30px;
    border-radius:20px;
    box-shadow:0 20px 50px rgba(0,0,0,.3);
}

/* FORM */

h1{
    text-align:center;
    color:#333;
    margin-bottom:10px;
}

.subtitle{
    text-align:center;
    color:#666;
    margin-bottom:20px;
}

.form-group{
    margin-bottom:15px;
}

label{
    font-weight:600;
    color:#333;
}

input{
    width:100%;
    padding:10px;
    border:2px solid #ddd;
    border-radius:10px;
    font-size:16px;
    margin-top:5px;
}

input.erro{
    border-color:#dc3545;
}

.msg-erro{
    color:#dc3545;
    font-size:14px;
    display:none;
    margin-top:5px;
}

.btn{
    width:100%;
    padding:15px;
    background:linear-gradient(135deg,#8b0000,#b22222);
    color:white;
    border:none;
    border-radius:12px;
    font-size:18px;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
    transition:transform 0.2s;
}

.btn:hover{
    transform:translateY(-2px);
}

/* ROLETA */

.roleta-wrapper{
    width:380px;
    height:380px;
    margin:20px auto;
    position:relative;
}

.seta{
    position:absolute;
    top:-40px;
    left:50%;
    transform:translateX(-50%);
    width:0;
    height:0;
    border-left:30px solid transparent;
    border-right:30px solid transparent;
    border-top:60px solid #ffd700;
    z-index:10;
    filter:drop-shadow(0 4px 6px rgba(0,0,0,0.3));
}

.roleta{
    width:100%;
    height:100%;
    border-radius:50%;
    position:relative;
    background:white;
    box-shadow:
        0 0 0 12px #D4AF37,
        0 0 0 16px #333,
        0 15px 30px rgba(0,0,0,.5);
    overflow:hidden;
}

.roleta-inner{
    width:100%;
    height:100%;
    border-radius:50%;
    position:relative;
    overflow:hidden;
    transition:transform 8s cubic-bezier(.17,.67,.12,.99);
}

/* GRÁFICO DE PIZZA - FATIAS ALTERNANDO VERMELHO E BRANCO */
.fatia{
    position:absolute;
    width:50%;
    height:50%;
    left:50%;
    top:50%;
    transform-origin:0 0;
    /* Removido clip-path para usar método de conic-gradient */
}

.fatia-text{
    position:absolute;
    font-weight:bold;
    font-size:18px;
    white-space:nowrap;
    z-index:2;
}

/* BOTÃO CENTRAL */

.centro{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:110px;
    height:110px;
    border-radius:50%;
    background:radial-gradient(circle,#FFD700,#FFA500,#FF8C00);
    display:flex;
    align-items:center;
    justify-content:center;
    border:4px solid #D4AF37;
    font-size:20px;
    color:white;
    font-weight:bold;
    cursor:pointer;
    z-index:20;
    box-shadow:0 6px 20px rgba(0,0,0,0.3);
    transition:transform 0.3s;
}

.centro:hover{
    transform:translate(-50%,-50%) scale(1.05);
}

.centro.girando{
    animation:pulsar 1s infinite;
}

@keyframes pulsar{
    0%{ transform:translate(-50%,-50%) scale(1); }
    50%{ transform:translate(-50%,-50%) scale(0.95); }
    100%{ transform:translate(-50%,-50%) scale(1); }
}

/* RESULTADO */

.resultado{
    text-align:center;
    display:none;
}

.resultado.show{
    display:block;
}

.resultado-premio{
    font-size:40px;
    font-weight:900;
    color:#8b0000;
    margin:20px 0;
    text-shadow:2px 2px 4px rgba(0,0,0,0.1);
}

.contador{
    text-align:center;
    margin-top:20px;
    font-size:14px;
    color:#666;
    background:#f8f9fa;
    padding:10px;
    border-radius:8px;
}

.contador span{
    font-weight:bold;
    color:#8b0000;
}
</style>
</head>

<body>

<div class="container">

<!-- FORMULÁRIO -->
<div id="formulario">

    <h1>Roleta da Sorte</h1>
    <p class="subtitle">Preencha seus dados para girar!</p>

    <div class="form-group">
        <label>Nome *</label>
        <input id="nome">
        <div id="errNome" class="msg-erro">Preencha o nome</div>
    </div>

    <div class="form-group">
        <label>Telefone *</label>
        <input id="telefone" maxlength="15">
        <div id="errTel" class="msg-erro">Preencha o telefone</div>
    </div>

    <div class="form-group">
        <label>CEP *</label>
        <input id="cep" maxlength="9">
        <div id="errCep" class="msg-erro">Preencha o CEP</div>
    </div>

    <div class="form-group">
        <label>Rua *</label>
        <input id="rua">
        <div id="errRua" class="msg-erro">Preencha a rua</div>
    </div>

    <div class="form-group">
        <label>Número *</label>
        <input id="numero">
        <div id="errNum" class="msg-erro">Preencha o número</div>
    </div>

    <div class="form-group">
        <label>Complemento (opcional)</label>
        <input id="complemento">
    </div>

    <button class="btn" onclick="avancarParaRoleta()">Girar a Roleta!</button>
</div>

<!-- ROLETA -->
<div id="roletaArea" style="display:none">

    <h1 id="saudacao" style="text-align:center;margin-bottom:10px"></h1>

    <div class="roleta-wrapper">

        <div class="seta"></div>

        <div class="roleta">
            <!-- Vamos usar canvas para um gráfico de pizza mais preciso -->
            <canvas id="roletaCanvas" width="380" height="380"></canvas>
            <div id="roletaInner" class="roleta-inner"></div>
        </div>

        <div id="btnGirar" class="centro" onclick="girarRoleta()">GIRAR</div>

    </div>

    <div class="contador">
        Prêmios restantes: 
        <span id="contadorCaneta">600</span> canetas | 
        <span id="contadorCopo">100</span> copos | 
        <span id="contadorAlmofada">50</span> almofadas | 
        <span id="contadorFone">50</span> fones
    </div>

</div>

<!-- RESULTADO -->
<div id="resultado" class="resultado">
    <h2>Parabéns!</h2>
    <p>Você ganhou:</p>
    <div id="premioGanho" class="resultado-premio"></div>
    <button class="btn" onclick="reiniciar()">Próximo participante</button>
</div>

</div>

<script>

/* GOOGLE SHEETS */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzojpuOhfwH1TfSKe0ITynGAVVa4xVQwwneCUvw1A5wqdbf-jhag_CvFHyaBxCWObYgsw/exec";

/* FATIAS - GRÁFICO DE PIZZA COM VERMELHO E BRANCO */
const PRIZES = ["CANETA","COPO","ALMOFADA","FONE"];
const COLORS = ["#FF0000", "#FFFFFF", "#FF0000", "#FFFFFF"]; // Alternando vermelho e branco
const TEXT_COLORS = ["#FFFFFF", "#000000", "#FFFFFF", "#000000"]; // Texto branco no vermelho, preto no branco

let premios = {
    "CANETA": {peso:85,total:600,distribuidos:0},
    "COPO": {peso:5,total:100,distribuidos:0},
    "ALMOFADA": {peso:5,total:50,distribuidos:0},
    "FONE": {peso:5,total:50,distribuidos:0}
};

let currentRotation = 0;
let spinning = false;

/* Máscaras */
telefone.addEventListener("input", e=>{
    let v=e.target.value.replace(/\D/g,'');
    if(v.length>2) v=v.replace(/^(\d{2})(\d)/,"($1) $2");
    if(v.length>7) v=v.replace(/(\d)(\d{4})$/,"$1-$2");
    e.target.value=v;
});

cep.addEventListener("input", e=>{
    let v=e.target.value.replace(/\D/g,'');
    if(v.length>5) v=v.replace(/^(\d{5})(\d)/,"$1-$2");
    e.target.value=v;
});

function desenharGraficoPizza() {
    const canvas = document.getElementById("roletaCanvas");
    const ctx = canvas.getContext("2d");
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2 - 10;
    
    // Limpar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Desenhar fundo dourado
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fillStyle = '#D4AF37';
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#333';
    ctx.stroke();
    
    // Desenhar fatias do gráfico de pizza
    const proporcoes = [85, 5, 5, 5]; // Caneta 85%, outros 5% cada
    let startAngle = 0;
    
    for(let i = 0; i < 4; i++) {
        const sliceAngle = (proporcoes[i] / 100) * (Math.PI * 2);
        const endAngle = startAngle + sliceAngle;
        
        // Desenhar fatia
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius - 12, startAngle, endAngle);
        ctx.closePath();
        
        // Preencher com cor alternada
        ctx.fillStyle = COLORS[i];
        ctx.fill();
        
        // Borda da fatia
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#333';
        ctx.stroke();
        
        // Desenhar texto
        const midAngle = startAngle + sliceAngle / 2;
        const textRadius = radius * 0.6;
        const textX = centerX + Math.cos(midAngle) * textRadius;
        const textY = centerY + Math.sin(midAngle) * textRadius;
        
        ctx.save();
        ctx.translate(textX, textY);
        
        // Rotacionar texto para ficar legível
        if (midAngle > Math.PI/2 && midAngle < 3*Math.PI/2) {
            ctx.rotate(midAngle + Math.PI);
        } else {
            ctx.rotate(midAngle);
        }
        
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = 'bold 16px Arial';
        ctx.fillStyle = TEXT_COLORS[i];
        
        // Nome do prêmio
        ctx.fillText(PRIZES[i], 0, 0);
        
        // Porcentagem
        ctx.font = '14px Arial';
        ctx.fillText(`${proporcoes[i]}%`, 0, 20);
        
        ctx.restore();
        
        startAngle = endAngle;
    }
    
    // Desenhar círculo central
    ctx.beginPath();
    ctx.arc(centerX, centerY, 55, 0, Math.PI * 2);
    ctx.fillStyle = '#FFD700';
    ctx.fill();
    ctx.lineWidth = 4;
    ctx.strokeStyle = '#D4AF37';
    ctx.stroke();
}

function construirGraficoPizza() {
    const inner = document.getElementById("roletaInner");
    inner.innerHTML = "";
    
    // Desenhar no canvas
    desenharGraficoPizza();
    
    // Manter o elemento rotacionável para a animação
    inner.style.transform = `rotate(0deg)`;
    
    // Adicionar elementos de texto flutuante para compatibilidade
    const proporcoes = [85, 5, 5, 5];
    let anguloAcumulado = 0;
    
    for(let i = 0; i < 4; i++) {
        const anguloFatia = (proporcoes[i] / 100) * 360;
        const anguloCentro = anguloAcumulado + (anguloFatia / 2);
        
        let texto = document.createElement("div");
        texto.className = "fatia-text";
        texto.textContent = PRIZES[i];
        texto.style.color = TEXT_COLORS[i];
        
        // Posicionar texto
        const raio = 120;
        const rad = (anguloCentro * Math.PI) / 180;
        const x = 190 + Math.cos(rad) * raio - 40;
        const y = 190 + Math.sin(rad) * raio - 15;
        
        texto.style.left = x + "px";
        texto.style.top = y + "px";
        texto.style.transform = `rotate(${anguloCentro}deg)`;
        
        inner.appendChild(texto);
        
        anguloAcumulado += anguloFatia;
    }
}

function atualizarContadores(){
    document.getElementById("contadorCaneta").textContent = premios.CANETA.total - premios.CANETA.distribuidos;
    document.getElementById("contadorCopo").textContent = premios.COPO.total - premios.COPO.distribuidos;
    document.getElementById("contadorAlmofada").textContent = premios.ALMOFADA.total - premios.ALMOFADA.distribuidos;
    document.getElementById("contadorFone").textContent = premios.FONE.total - premios.FONE.distribuidos;
}

window.onload = function() {
    construirGraficoPizza();
    atualizarContadores();
};

/* Validar */
function validar(id,err){
    const el=document.getElementById(id);
    const msg=document.getElementById(err);

    if(!el.value.trim()){
        el.classList.add("erro");
        msg.style.display="block";
        return false;
    }
    el.classList.remove("erro");
    msg.style.display="none";
    return true;
}

/* Avançar */
function avancarParaRoleta(){
    const ok =
        validar("nome","errNome") &&
        validar("telefone","errTel") &&
        validar("cep","errCep") &&
        validar("rua","errRua") &&
        validar("numero","errNum");

    if(!ok) return;

    formulario.style.display="none";
    roletaArea.style.display="block";
    saudacao.textContent="Boa sorte, "+nome.value.split(" ")[0]+"!";
}

/* Sorteio */
function sortear(){
    let lista=Object.entries(premios).filter(([k,v])=>v.distribuidos < v.total);
    let totalPeso=lista.reduce((t,[k,v])=>t+v.peso,0);

    let r=Math.random()*totalPeso;

    for(const [nome,info] of lista){
        r-=info.peso;
        if(r<=0) return nome;
    }
}

/* Giro */
function girarRoleta(){
    if(spinning) return;

    let premio=sortear();
    let idx=PRIZES.indexOf(premio);
    
    // Proporções para calcular ângulos corretos
    const proporcoes = [85, 5, 5, 5];
    
    // Calcular ângulo acumulado até o prêmio
    let anguloAcumulado = 0;
    for(let i = 0; i < idx; i++){
        anguloAcumulado += (proporcoes[i] / 100) * 360;
    }
    
    // Ângulo do centro da fatia sorteada
    const anguloFatia = (proporcoes[idx] / 100) * 360;
    const anguloCentro = anguloAcumulado + (anguloFatia / 2);

    spinning=true;
    btnGirar.classList.add("girando");
    btnGirar.textContent="...";

    // Giro com rotação extra para efeito visual
    let finalRotation = currentRotation + 1440 + (360 - anguloCentro);
    roletaInner.style.transform = `rotate(${finalRotation}deg)`;
    currentRotation = finalRotation % 360;

    setTimeout(()=>{
        premios[premio].distribuidos++;
        atualizarContadores();

        // Enviar dados para Google Sheets
        fetch(SCRIPT_URL, {
            method:"POST",
            mode:"no-cors",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
                nome:nome.value,
                telefone:telefone.value,
                cep:cep.value,
                rua:rua.value,
                numero:numero.value,
                complemento:complemento.value,
                premio,
                data:new Date().toLocaleString("pt-BR")
            })
        }).catch(err => console.log("Erro ao enviar:", err));

        premioGanho.textContent=premio;

        roletaArea.style.display="none";
        resultado.classList.add("show");

        btnGirar.classList.remove("girando");
        btnGirar.textContent="GIRAR";

        spinning=false;

    },8000);
}

/* Reiniciar */
function reiniciar(){
    resultado.classList.remove("show");
    formulario.style.display="block";

    nome.value="";
    telefone.value="";
    cep.value="";
    rua.value="";
    numero.value="";
    complemento.value="";

    document.querySelectorAll(".msg-erro").forEach(e=>e.style.display="none");
    document.querySelectorAll("input").forEach(e=>e.classList.remove("erro"));
}

</script>

</body>
</html>
