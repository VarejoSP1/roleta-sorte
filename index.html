<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Roleta da Sorte</title>

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #8b0000, #b22222);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .container {
        width: 520px;
        background: #fff;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    }

    h1 { text-align:center; margin-bottom:10px; color:#333; }
    .subtitle { text-align:center; color:#666; margin-bottom:20px; }

    .form-group { margin-bottom: 15px; }
    label { font-weight: 600; }

    input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 10px;
        margin-top: 5px;
        font-size: 16px;
    }

    .btn {
        width:100%; padding:15px; margin-top:10px;
        background: linear-gradient(135deg,#8b0000,#b22222);
        border:none; border-radius:12px;
        color:white; font-size:17px; font-weight:700;
        cursor:pointer;
    }

    .roleta-wrapper {
        width:380px; height:380px;
        margin:20px auto; position:relative;
    }

    .seta {
        position:absolute;
        top:-40px; left:50%;
        transform:translateX(-50%);
        width:0; height:0;
        border-left:30px solid transparent;
        border-right:30px solid transparent;
        border-top:60px solid #ffd700;
        z-index:9999;
    }

    .roleta-inner {
        width:100%; height:100%;
        border-radius:50%;
        transition:transform 8s cubic-bezier(.17,.67,.12,.99);
        position:relative; overflow:hidden;
        box-shadow:0 0 0 12px #d4af37, 0 0 0 16px #333;
        transform: rotate(-90deg);
    }

    .slice {
        position:absolute;
        width:100%; height:100%;
        transform-origin:center center;
        clip-path: polygon(50% 50%, 50% 0%, 100% 0%);
    }

    .slice-label {
        position:absolute;
        left:50%; top:50%;
        transform-origin:center center;
        font-size:16px; font-weight:800;
        white-space:nowrap;
        pointer-events:none;
        color:#000;
        max-width:120px;
        text-align:center;
        overflow:hidden;
        transform: rotate(90deg);
    }

    .centro {
        position:absolute;
        left:50%; top:50%;
        transform:translate(-50%,-50%);
        width:110px; height:110px;
        background:radial-gradient(circle,#ffd700,#ffa500,#ff8c00);
        border-radius:50%;
        border:4px solid #d4af37;
        display:flex; align-items:center; justify-content:center;
        font-size:18px; font-weight:900; color:#fff;
        cursor:pointer; z-index:9999;
    }

    .centro.girando { opacity:0.7; pointer-events:none; }

    .resultado { text-align:center; display:none; }
    .resultado.show { display:block; }

    .resultado-premio {
        font-size:42px; font-weight:900;
        color:#667eea; margin:20px 0;
    }
    
    .msg-erro {
        color: #ff0000;
        font-size: 14px;
        margin-top: 5px;
        display: none;
    }
</style>
</head>

<body>
<div class="container">

<!-- FORMULÁRIO -->
<div id="formulario">
    <h1>Roleta da Sorte</h1>
    <p class="subtitle">Preencha seus dados para girar!</p>

    <div class="form-group">
        <label>Nome *</label>
        <input id="nome" />
        <div id="errNome" class="msg-erro">Preencha o nome</div>
    </div>

    <div class="form-group">
        <label>Telefone *</label>
        <input id="telefone" maxlength="15" />
        <div id="errTel" class="msg-erro">Preencha o telefone</div>
    </div>

    <div class="form-group">
        <label>CEP *</label>
        <input id="cep" maxlength="9" />
        <div id="errCep" class="msg-erro">Preencha o CEP</div>
    </div>

    <div class="form-group">
        <label>Rua *</label>
        <input id="rua" />
        <div id="errRua" class="msg-erro">Preencha a rua</div>
    </div>

    <div class="form-group">
        <label>Número *</label>
        <input id="numero" />
        <div id="errNum" class="msg-erro">Preencha o número</div>
    </div>

    <div class="form-group">
        <label>Complemento (opcional)</label>
        <input id="complemento" />
    </div>

    <button class="btn" onclick="avancarParaRoleta()">Girar a Roleta!</button>
</div>

<!-- ROLETA -->
<div id="roletaArea" style="display:none">
    <h1 id="saudacao" style="text-align:center;margin-bottom:10px"></h1>

    <div class="roleta-wrapper">
        <div class="seta"></div>

        <div class="roleta-inner" id="roletaInner"></div>

        <div id="btnGirar" class="centro" onclick="girarRoleta()">GIRAR</div>
    </div>
</div>

<!-- RESULTADO -->
<div id="resultado" class="resultado">
    <h2>Parabéns!</h2>
    <p>Você ganhou:</p>
    <div id="premioGanho" class="resultado-premio"></div>

    <button class="btn" onclick="reiniciar()">Próximo participante</button>
</div>

</div>

<script>
/* CONFIG */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzojpuOhfwH1TfSKe0ITynGAVVa4xVQwwneCUvw1A5wqdbf-jhag_CvFHyaBxCWObYgsw/exec";

const DURATION_MS = 8000;

/* PRÊMIOS COM PROBABILIDADES */
const PREMIOS = [
    { nome: "Caneta", probabilidade: 85, cor: "#FF6B6B", borda: "#FF4757" },
    { nome: "Copo", probabilidade: 5, cor: "#4ECDC4", borda: "#45B7AA" },
    { nome: "Almofada", probabilidade: 5, cor: "#FFD166", borda: "#FFC145" },
    { nome: "Fone", probabilidade: 5, cor: "#6A0572", borda: "#5A0466" }
];

let currentRotation = 0;
let spinning = false;
let formData = {};

/* MÁSCARAS */
telefone.addEventListener("input", e => {
    let v = e.target.value.replace(/\D/g, "");
    if (v.length > 2) v = v.replace(/^(\d{2})(\d)/, "($1) $2");
    if (v.length > 7) v = v.replace(/(\d)(\d{4})$/, "$1-$2");
    e.target.value = v;
});

cep.addEventListener("input", e => {
    let v = e.target.value.replace(/\D/g, "");
    if (v.length > 5) v = v.replace(/^(\d{5})(\d)/, "$1-$2");
    e.target.value = v;
});

/* MONTA A ROLETA COM FATIAS DE PIZZA */
function buildWheel() {
    const inner = document.getElementById("roletaInner");
    inner.innerHTML = "";
    
    let currentAngle = 0;
    const totalProbability = PREMIOS.reduce((sum, p) => sum + p.probabilidade, 0);
    
    PREMIOS.forEach((premio, i) => {
        // Calcular ângulo da fatia baseado na probabilidade
        const sliceAngle = (premio.probabilidade / totalProbability) * 360;
        
        // Criar fatia
        const slice = document.createElement("div");
        slice.className = "slice";
        slice.style.backgroundColor = premio.cor;
        slice.style.border = `2px solid ${premio.borda}`;
        slice.style.transform = `rotate(${currentAngle}deg)`;
        slice.style.clipPath = `polygon(50% 50%, 50% 0%, ${50 + 50 * Math.cos(sliceAngle * Math.PI / 180)}% ${50 - 50 * Math.sin(sliceAngle * Math.PI / 180)}%)`;
        
        // Criar label
        const label = document.createElement("div");
        label.className = "slice-label";
        label.textContent = premio.nome.toUpperCase();
        label.style.color = premio.probabilidade === 85 ? "#FFF" : "#000";
        label.style.fontWeight = "900";
        label.style.textShadow = premio.probabilidade === 85 ? "1px 1px 2px rgba(0,0,0,0.5)" : "none";
        
        // Posicionar label no centro da fatia
        const labelAngle = currentAngle + (sliceAngle / 2);
        const radius = 120;
        const x = radius * Math.cos((labelAngle - 90) * Math.PI / 180);
        const y = radius * Math.sin((labelAngle - 90) * Math.PI / 180);
        
        label.style.transform = `
            translate(calc(-50% + ${x}px), calc(-50% + ${y}px))
            rotate(${labelAngle}deg)
        `;
        
        slice.appendChild(label);
        inner.appendChild(slice);
        
        currentAngle += sliceAngle;
    });
}

window.onload = buildWheel;

/* VALIDAÇÃO */
function validar(id, msg) {
    let el = document.getElementById(id);
    let msgEl = document.getElementById(msg);

    if (!el.value.trim()) {
        msgEl.style.display = "block";
        return false;
    }

    msgEl.style.display = "none";
    return true;
}

/* AVANÇAR */
function avancarParaRoleta() {
    if (
        !validar("nome","errNome") |
        !validar("telefone","errTel") |
        !validar("cep","errCep") |
        !validar("rua","errRua") |
        !validar("numero","errNum")
    ) return;

    formData = {
        nome: nome.value,
        telefone: telefone.value,
        cep: cep.value,
        rua: rua.value,
        numero: numero.value,
        complemento: complemento.value
    };

    formulario.style.display = "none";
    roletaArea.style.display = "block";

    saudacao.textContent = "Boa sorte, " + nome.value.split(" ")[0] + "!";
}

/* SORTEIO BASEADO NA PROBABILIDADE */
function drawPrize() {
    const totalProbability = PREMIOS.reduce((sum, p) => sum + p.probabilidade, 0);
    let randomValue = Math.random() * totalProbability;
    
    let cumulative = 0;
    for (const premio of PREMIOS) {
        cumulative += premio.probabilidade;
        if (randomValue <= cumulative) {
            return premio.nome;
        }
    }
    
    return PREMIOS[0].nome; // fallback
}

/* GIRO DA ROLETA */
function girarRoleta() {
    if (spinning) return;

    const premioEscolhido = drawPrize();
    const premioIndex = PREMIOS.findIndex(p => p.nome === premioEscolhido);
    
    // Calcular ângulo de cada prêmio acumulado
    let cumulativeAngle = 0;
    for (let i = 0; i < premioIndex; i++) {
        cumulativeAngle += (PREMIOS[i].probabilidade / 100) * 360;
    }
    
    // Calcular posição central da fatia sorteada
    const premioAngle = (PREMIOS[premioIndex].probabilidade / 100) * 360;
    const targetAngle = cumulativeAngle + (premioAngle / 2);
    
    spinning = true;
    btnGirar.classList.add("girando");
    btnGirar.textContent = "...";

    // 5 voltas completas + ângulo para parar na fatia escolhida
    const spins = 5;
    const finalRotation = currentRotation + (spins * 360) + (360 - targetAngle) + 90;

    roletaInner.style.transform = `rotate(${-finalRotation}deg)`;
    currentRotation = finalRotation % 360;

    setTimeout(() => {
        // Enviar dados para Google Sheets
        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ...formData,
                premio: premioEscolhido,
                data: new Date().toLocaleString("pt-BR")
            })
        });

        premioGanho.textContent = premioEscolhido;

        roletaArea.style.display = "none";
        resultado.classList.add("show");

        btnGirar.classList.remove("girando");
        btnGirar.textContent = "GIRAR";
        spinning = false;

    }, DURATION_MS + 200);
}

/* REINICIAR */
function reiniciar() {
    resultado.classList.remove("show");
    formulario.style.display = "block";

    nome.value = "";
    telefone.value = "";
    cep.value = "";
    rua.value = "";
    numero.value = "";
    complemento.value = "";
}

</script>

</body>
</html>
