<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roleta da Sorte</title>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
}

body{
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(135deg,#8b0000,#b22222);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
}

.container{
    width:520px;
    background:white;
    padding:30px;
    border-radius:20px;
    box-shadow:0 20px 50px rgba(0,0,0,.3);
}

h1{
    text-align:center;
    color:#333;
    margin-bottom:10px;
}

.subtitle{
    text-align:center;
    color:#666;
    margin-bottom:20px;
}

.form-group{
    margin-bottom:15px;
}

label{
    font-weight:600;
    color:#333;
}

input{
    width:100%;
    padding:10px;
    border:2px solid #ddd;
    border-radius:10px;
    font-size:16px;
    margin-top:5px;
}

input.erro{
    border-color:#dc3545;
}

.msg-erro{
    color:#dc3545;
    font-size:14px;
    display:none;
    margin-top:5px;
}

.btn{
    width:100%;
    padding:15px;
    background:linear-gradient(135deg,#8b0000,#b22222);
    color:white;
    border:none;
    border-radius:12px;
    font-size:18px;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
}

.roleta-wrapper{
    width:380px;
    height:380px;
    margin:20px auto;
    position:relative;
}

.seta{
    position:absolute;
    top:-40px;
    left:50%;
    transform:translateX(-50%);
    width:0;
    height:0;
    border-left:30px solid transparent;
    border-right:30px solid transparent;
    border-top:60px solid #ffd700;
    z-index:10;
}

.roleta{
    width:100%;
    height:100%;
    border-radius:50%;
    position:relative;
    background:white;
    box-shadow:
        0 0 0 12px #D4AF37,
        0 0 0 16px #333,
        0 15px 30px rgba(0,0,0,.5);
}

.roleta-canvas{
    width:100%;
    height:100%;
    border-radius:50%;
}

.centro{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:110px;
    height:110px;
    border-radius:50%;
    background:radial-gradient(circle,#FFD700,#FFA500,#FF8C00);
    display:flex;
    align-items:center;
    justify-content:center;
    border:4px solid #D4AF37;
    font-size:20px;
    color:white;
    font-weight:bold;
    cursor:pointer;
    z-index:20;
    box-shadow:0 4px 8px rgba(0,0,0,0.3);
}

.centro:hover{
    transform:translate(-50%,-50%) scale(1.05);
}

.resultado{
    text-align:center;
    display:none;
}

.resultado.show{
    display:block;
}

.resultado-premio{
    font-size:40px;
    font-weight:900;
    color:#667eea;
    margin:20px 0;
}

</style>
</head>

<body>

<div class="container">

<!-- FORMULÁRIO -->
<div id="formulario">

    <h1>Roleta da Sorte</h1>
    <p class="subtitle">Preencha seus dados para girar!</p>

    <div class="form-group">
        <label>Nome *</label>
        <input id="nome">
        <div id="errNome" class="msg-erro">Preencha o nome</div>
    </div>

    <div class="form-group">
        <label>Telefone *</label>
        <input id="telefone" maxlength="15">
        <div id="errTel" class="msg-erro">Preencha o telefone</div>
    </div>

    <div class="form-group">
        <label>CEP *</label>
        <input id="cep" maxlength="9">
        <div id="errCep" class="msg-erro">Preencha o CEP</div>
    </div>

    <div class="form-group">
        <label>Rua *</label>
        <input id="rua">
        <div id="errRua" class="msg-erro">Preencha a rua</div>
    </div>

    <div class="form-group">
        <label>Número *</label>
        <input id="numero">
        <div id="errNum" class="msg-erro">Preencha o número</div>
    </div>

    <div class="form-group">
        <label>Complemento (opcional)</label>
        <input id="complemento">
    </div>

    <button class="btn" onclick="avancarParaRoleta()">Girar a Roleta!</button>
</div>

<!-- ROLETA -->
<div id="roletaArea" style="display:none">

    <h1 id="saudacao" style="text-align:center;margin-bottom:10px"></h1>

    <div class="roleta-wrapper">

        <div class="seta"></div>

        <div class="roleta">
            <canvas id="roletaCanvas" class="roleta-canvas" width="380" height="380"></canvas>
        </div>

        <div id="btnGirar" class="centro" onclick="girarRoleta()">GIRAR</div>

    </div>

</div>

<!-- RESULTADO -->
<div id="resultado" class="resultado">
    <h2>Parabéns!</h2>
    <p>Você ganhou:</p>
    <div id="premioGanho" class="resultado-premio"></div>
    <button class="btn" onclick="reiniciar()">Próximo participante</button>
</div>

</div>

<script>

/* GOOGLE SHEETS */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzojpuOhfwH1TfSKe0ITynGAVVa4xVQwwneCUvw1A5wqdbf-jhag_CvFHyaBxCWObYgsw/exec";

/* CONFIGURAÇÃO DA ROLETA */
const PRIZES = [
    {text: "CANETA", color: "#dc143c"},
    {text: "COPO", color: "#fff"},
    {text: "ALMOFADA", color: "#dc143c"},
    {text: "CHAVEIRO", color: "#fff"}
];

let currentRotation = 0;
let spinning = false;
let canvas, ctx;

let premios = {
    "CANETA": {peso:90,total:600,distribuidos:0},
    "COPO": {peso:3.33,total:100,distribuidos:0},
    "ALMOFADA": {peso:3.33,total:50,distribuidos:0},
    "CHAVEIRO": {peso:3.34,total:50,distribuidos:0}
};

/* Máscaras */
telefone.addEventListener("input", e=>{
    let v=e.target.value.replace(/\D/g,'');
    if(v.length>2) v=v.replace(/^(\d{2})(\d)/,"($1) $2");
    if(v.length>7) v=v.replace(/(\d)(\d{4})$/,"$1-$2");
    e.target.value=v;
});

cep.addEventListener("input", e=>{
    let v=e.target.value.replace(/\D/g,'');
    if(v.length>5) v=v.replace(/^(\d{5})(\d)/,"$1-$2");
    e.target.value=v;
});

/* Desenhar roleta com Canvas */
function drawWheel() {
    if (!canvas) {
        canvas = document.getElementById('roletaCanvas');
        ctx = canvas.getContext('2d');
    }

    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width / 2 - 10;
    const sliceAngle = (2 * Math.PI) / PRIZES.length;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Desenhar cada fatia - A PRIMEIRA FATIA COMEÇA NO TOPO (-PI/2)
    PRIZES.forEach((prize, index) => {
        const startAngle = (index * sliceAngle) - (Math.PI / 2) + (currentRotation * Math.PI / 180);
        const endAngle = startAngle + sliceAngle;

        // Desenhar fatia
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = prize.color;
        ctx.fill();
        
        // Borda da fatia
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 3;
        ctx.stroke();

        // Texto
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(startAngle + sliceAngle / 2);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = prize.color === '#fff' ? '#000' : '#fff';
        ctx.font = 'bold 20px Arial';
        ctx.shadowColor = 'rgba(0,0,0,0.3)';
        ctx.shadowBlur = 2;
        ctx.fillText(prize.text, radius * 0.65, 0);
        ctx.restore();
    });

    requestAnimationFrame(drawWheel);
}

window.onload = () => {
    drawWheel();
};

/* Validar */
function validar(id,err){
    const el=document.getElementById(id);
    const msg=document.getElementById(err);

    if(!el.value.trim()){
        el.classList.add("erro");
        msg.style.display="block";
        return false;
    }
    el.classList.remove("erro");
    msg.style.display="none";
    return true;
}

/* Avançar */
function avancarParaRoleta(){
    const ok =
        validar("nome","errNome") &
        validar("telefone","errTel") &
        validar("cep","errCep") &
        validar("rua","errRua") &
        validar("numero","errNum");

    if(!ok) return;

    formulario.style.display="none";
    roletaArea.style.display="block";
    saudacao.textContent="Boa sorte, "+nome.value.split(" ")[0]+"!";
}

/* Sorteio */
function sortear(){
    let lista=Object.entries(premios).filter(([k,v])=>v.distribuidos < v.total);
    let totalPeso=lista.reduce((t,[k,v])=>t+v.peso,0);

    let r=Math.random()*totalPeso;

    for(const [nome,info] of lista){
        r-=info.peso;
        if(r<=0) return nome;
    }
    return "CANETA";
}

/* Giro com animação suave */
function girarRoleta(){
    if(spinning) return;

    let premioSorteado = sortear();
    let idx = PRIZES.findIndex(p => p.text === premioSorteado);

    spinning = true;
    btnGirar.style.cursor = 'not-allowed';
    btnGirar.textContent = "...";

    const sliceAngle = 360 / PRIZES.length;
    
    // Centro da fatia sorteada (em graus)
    const prizeCenterAngle = (idx * sliceAngle) + (sliceAngle / 2);
    
    // Voltas completas
    const spins = 1800;
    
    // A seta aponta para -90° (topo do canvas)
    // Queremos que o centro da fatia fique em -90° também
    // Se a fatia está em prizeCenterAngle, precisamos girar: -90 - prizeCenterAngle
    // Mas como começamos desenhando com offset -90, ajustamos:
    const targetRotation = 360 - prizeCenterAngle;
    
    const finalRotation = spins + targetRotation;
    
    const startTime = Date.now();
    const duration = 4000; // Reduzido de 8000 para 4000ms (4 segundos)
    const startRotation = currentRotation;

    function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const easeOut = 1 - Math.pow(1 - progress, 3);
        currentRotation = startRotation + (finalRotation - startRotation) * easeOut;

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            currentRotation = finalRotation % 360;
            
            // Detectar qual fatia está no topo
            // A seta aponta para 270° (ou -90°) no sistema de coordenadas
            // Com a rotação aplicada, precisamos ver qual fatia está nessa posição
            const normalizedRotation = ((currentRotation % 360) + 360) % 360;
            
            // Qual fatia está no topo (-90° ou 270°)?
            // Posição da fatia = (índice * sliceAngle) + rotação - 90
            // Queremos: posição = 270 (topo)
            // Então: (idx * sliceAngle) + rotação - 90 = 270
            // idx * sliceAngle = 360 - rotação
            const angleAtTop = (360 - normalizedRotation) % 360;
            const sliceAtTop = Math.floor(angleAtTop / sliceAngle) % PRIZES.length;
            
            const premioReal = PRIZES[sliceAtTop].text;
            
            console.log("Sorteado:", premioSorteado, "Parou em:", premioReal);
            
            finalizarGiro(premioReal);
        }
    }

    animate();
}

function finalizarGiro(premio) {
    premios[premio].distribuidos++;

    fetch(SCRIPT_URL, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            nome:nome.value,
            telefone:telefone.value,
            cep:cep.value,
            rua:rua.value,
            numero:numero.value,
            complemento:complemento.value,
            premio,
            data:new Date().toLocaleString("pt-BR")
        })
    });

    premioGanho.textContent = premio;

    roletaArea.style.display = "none";
    resultado.classList.add("show");

    btnGirar.style.cursor = 'pointer';
    btnGirar.textContent = "GIRAR";

    spinning = false;
}

/* Reiniciar */
function reiniciar(){
    resultado.classList.remove("show");
    formulario.style.display="block";

    nome.value="";
    telefone.value="";
    cep.value="";
    rua.value="";
    numero.value="";
    complemento.value="";

    document.querySelectorAll(".msg-erro").forEach(e=>e.style.display="none");
    document.querySelectorAll("input").forEach(e=>e.classList.remove("erro"));
}

</script>

</body>
</html>
